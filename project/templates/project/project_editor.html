{% extends 'template.html' %}
{% load static %}

{% block title %}{% endblock %}
{% block page_title %}Проект | {{ project.title }}{% endblock %}

{% block content %}
    <style>
        .mb-3 {
            margin-bottom: 0 !important;
        }
        .btn_edit {
            font-size: 10px;
            background-color: paleturquoise;
            cursor: pointer;
            padding: 2px 4px 2px 4px;
            border-radius: 3px;
        }
        h4 {
            padding: 15px 0 15px 0;
            /*text-align: center;*/
        }
    </style>

    {{ project|json_script:'project_json' }}
    {{ specificities|json_script:'specificities_json' }}
    <div id="app_project_id"></div>
{% endblock %}

{% block end_of_body %}
    {{ block.super }}
    <script>
        var IS_AUTHENTICATED = {% if request.user.is_authenticated %}true{% else %}false{% endif %};
			  var CSRF_TOKEN = "{{ csrf_token }}";
			  var URL_PROJECT = '/edit';
			  var URL_ADD_NEWS = '/publicate-news'
			  var URL_SAVE_SPECIFICITY = '/save-specificity'
			  var USERNMAE = '{{ request.user.username }}';
			  TITLE_VERBOSE_NAME = '{{ fields.title.verbose_name }}';
			  SHORT_DESCRIPTION_VERBOSE_NAME = '{{ fields.short_description.verbose_name }}';
			  DESCRIPTION_VERBOSE_NAME = '{{ fields.description.verbose_name }}';
		</script>

    <script>
        TeleportToHeaderComponent = {template: `<teleport to="h1"><slot/></teleport>`};
    </script>

    <script src="{% static 'project/field-input-component.js' %}?v=1"></script>
    <script src="{% static 'project/field-textarea-component.js' %}?v=1"></script>
    <script src="{% static 'project/field-editor-component.js' %}?v=1"></script>
    <script src="{% static 'project/news-component.js' %}?v=1"></script>
    <script src="{% static 'project/news-block-component.js' %}?v=1"></script>

    <script>
        function send_form(request) {
            /*
            Required fields: url, success, self, form
            Not required: headers, statusCode, post, dataType, data
            */
            let headers = request.headers || {};
            headers['X-CSRFToken'] = CSRF_TOKEN;
            let form = request.form;

            statusCode = request.statusCode || {
								500: function(xhr) {
								    clear_status_fields(form);
										request.self.errorMessage = 'ошибка сохранения';
								},
								400: function(xhr) {
										request.self.errorMessage = '';
										clear_status_fields(form);
										set_invalid_field(form, xhr.responseJSON);
								},
						}

            $.ajax({
                url: request.url,
                headers: headers,
                dataType: request.dataType || 'json',
                data: request.data || $(form).serialize(),
                success: request.success,
                statusCode: statusCode,
                method: request.method || "post",
            });
        }
    </script>

    <script>
			  LinkerItemFaciComponent = {
			      props: ['object'],
			      template: `
                <li>
								    <a :href="object.url" target="_blank">[[object.aim]]</a>
							  </li>
					  `,
			  }
		</script>

    <script>
			  LinkerItemNoteComponent = {
			      props: ['object'],
			      template: `
                <li>
								    <a :href="object.url" target="_blank">[[object.title]]</a>
							  </li>
					  `,
			  }
		</script>

    <script src="{% static 'project/linker-component.js' %}"></script>

    <script>
				SpecificitiesComponent = {
				    props: ['specificity', 'isNew'],
						data() {
								let specificities = JSON.parse(document.getElementById('specificities_json').textContent);
								return {
										specificities: specificities,
										mSpecificity: this.specificity,
										badMessage: '',
										is_auth: IS_AUTHENTICATED,
								};
						},
						template: `
						    <h4>Специфика проекта</h4>
						    <form v-if="!isNew">
										<div class="form-floating">
												<select class="form-select" id="specificity-field" v-model="mSpecificity" name="specificity">
												    <option value="null" :selected="!mSpecificity">Не выбрано</option>
														<option :value="specificity[0]" v-for="specificity of specificities" :selected="mSpecificity == specificity[0]">[[ specificity[1] ]]</option>
												</select>
												<label for="specificity-field">Специфика</label>
										</div>
										<br>
										<div v-if="badMessage">[[ badMessage ]]</div>
										<div style="text-align: right;" v-if="is_auth">
										    <input type="button" value="Сохранить" class="btn btn-outline-secondary" @click="save">
										</div>
								</form>
						`,
						methods: {
						    save(event) {
						        let self = this;
						        let form = event.target.form;
						        $.ajax({
                        url: window.location.href + URL_SAVE_SPECIFICITY,
                        headers: {"X-CSRFToken": CSRF_TOKEN},
                        dataType: 'json',
                        data: {specificity: self.mSpecificity},
                        success: function(result) {
                            self.badMessage = '';
                            set_valid_field(form, result.updated_fields);
                        },
                        statusCode: {
                            500: function(xhr) {
                                self.badMessage = 'ошибка сервера'
                            },
                            400: function(xhr) {
                                clear_status_fields(form);
                                set_invalid_field(form, xhr.responseJSON);
                                self.badMessage = '';
                            },
                            404: function(xhr) {
                                self.badMessage = 'такой проект не существует'
                            },
                        },
                        method: "post"
                    });
						    }
						},
				}
 		</script>

    <script src="{% static 'project/project-component.js' %}"></script>

    <script>
        const { createApp } = Vue;

        var app_project = createApp(ProjectComponent);
        app_project.config.compilerOptions.delimiters = [ '[[', ']]' ];
        app_project.mount('#app_project_id');
    </script>
{% endblock %}
