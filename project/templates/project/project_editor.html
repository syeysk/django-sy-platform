{% extends 'template.html' %}
{% load static %}

{% block title %}{% endblock %}
{% block page_title %}Проект | {{ project.title }}{% endblock %}

{% block content %}
    <style>
        .mb-3 {
            margin-bottom: 0 !important;
        }
        .btn_edit {
            font-size: 10px;
            background-color: paleturquoise;
            cursor: pointer;
            padding: 2px 4px 2px 4px;
            border-radius: 3px;
        }
    </style>

    {{ project|json_script:'project_json' }}
    <div id="app_project_id"></div>
{% endblock %}

{% block end_of_body %}
    {{ block.super }}
    <script>
        var IS_AUTHENTICATED = {% if request.user.is_authenticated %}true{% else %}false{% endif %};
			  var CSRF_TOKEN = "{{ csrf_token }}";
			  var URL_PROJECT = '';
		</script>

    <script>
        TeleportToHeaderComponent = {template: `<teleport to="h1"><slot/></teleport>`};
    </script>

    <script src="{% static 'project/field-input-component.js' %}"></script>
    <script src="{% static 'project/field-textarea-component.js' %}"></script>
    <script src="{% static 'project/field-editor-component.js' %}"></script>

    <script>
        function send_form(request) {
            /*
            Required fields: url, success, self, form
            Not required: headers, statusCode, post, dataType, data
            */
            let headers = request.headers || {};
            headers['X-CSRFToken'] = CSRF_TOKEN;
            let form = request.form;

            statusCode = request.statusCode || {
								500: function(xhr) {
								    clear_status_fields(form);
										request.self.errorMessage = 'ошибка сохранения';
								},
								400: function(xhr) {
										request.self.errorMessage = '';
										clear_status_fields(form);
										set_invalid_field(form, xhr.responseJSON);
								},
						}

            $.ajax({
                url: request.url,
                headers: headers,
                dataType: request.dataType || 'json',
                data: request.data || $(form).serialize(),
                success: request.success,
                statusCode: statusCode,
                method: request.method || "post",
            });
        }
    </script>

    <script>
			  LinkerItemFaciComponent = {
			      props: ['object'],
			      template: `
                <li>
								    <a :href="object.url" target="_blank">[[object.aim]]</a>
							  </li>
					  `,
			  }
		</script>

    <script>
			  LinkerItemNoteComponent = {
			      props: ['object'],
			      template: `
                <li>
								    <a :href="object.url" target="_blank">[[object.title]]</a>
							  </li>
					  `,
			  }
		</script>

    <script src="{% static 'project/linker-component.js' %}"></script>

    <script>
			  NewsComponent = {
			      props: ['text', 'datetime'],
			      components: {},
			      template: `
			          <span>[[ datetime ]]</span>
			          <p>[[ text ]]</p>
			      `,
			  }
 		</script>

    <script>
			  NewsBlockComponent = {
			      props: ['project_news'],
			      components: {NewsComponent},
			      data() {
			          return {isView: true, added_text: '', is_auth: IS_AUTHENTICATED};
			      },
			      methods: {
			          startAdding(event) {
			              this.isView = false;
			          },
			          publicate(event) {
			              this.project_news.unshift({text: this.added_text, datetime: '4565-45-45 65:87'});
			              if (this.project_news.length > 10) {
			                  this.project_news.pop();
			              }
			              this.isView = true;
			              this.added_text = '';
			          },
			          cancel(event) {
			              this.isView = true;
			              this.added_text = '';
			          },
			      },
			      template: `
			      <form>
			          <input type="button" value="Добавить новость" class="btn btn-outline-secondary" v-if="is_auth && isView" @click="startAdding">
			          <div v-if="!isView">
										<div class="mb-3 form-group" id="added_text-group">
												<div class="form-floating">
														<textarea v-model="added_text" name="added_text" style="width: 100%;" rows="5" class="form-control"></textarea>
														<label for="added_text-field" class="form-label">Текст новости</label>
												</div>
										</div>
										<br>
										<input type="button" value="Опубликовать" class="btn btn-outline-secondary" @click="publicate">
										<input type="button" value="Отменить" class="btn btn-outline-secondary" @click="cancel">
    							  <br><br>
			          </div>
			      </form>
						<news-component
								v-for="news in project_news"
								:text="news.text"
								:datetime="news.datetime"
						></news-component>
			      `,
			  }
 		</script>

    <script>
        ProjectComponent = {
            props: [],
            components: {FieldEditorComponent, LinkerComponent, NewsBlockComponent},
            data() {
                let isNew = !Boolean(project_object);
                return {
                    title: isNew ? '' : project_object.title,
                    short_description: isNew ? '' : project_object.short_description,
                    description: isNew ? '' : project_object.description,
                    created_by: isNew ? '{{ request.user.username }}' : project_object.created_by,
                    facis: isNew ? {} : project_object.facis,
                    notes: isNew ? {} : project_object.notes,
                    news: isNew ? [] : project_object.news,
                    isNew: isNew,
                };
            },
            methods: {
                save_project(event, fieldComponent) {
                    let self = this;
                    let form = event.target.form;
                    if (this.isNew) {
                        send_form({
                            url: URL_PROJECT,
                            form: event.target.form,
                            success: function(result) {
                                fieldComponent.errorMessage = '';
                                history.pushState(
                                    null,
                                    null,
                                    location.href.replace('/new', '/' + result.project_id),
                                );
                                fieldComponent.set_view();
                                self.isNew = false;
                            },
                            'self': fieldComponent,
                            'form': form,
                        });
                    } else {
                        send_form({
                            url: URL_PROJECT,
                            form: event.target.form,
                            success: function(result) {
                                clear_status_fields(form);
                                set_valid_field(form, result.updated_fields);
                                self.successMessage = '';
                                fieldComponent.set_view();
                            },
                            'self': fieldComponent,
                            'form': form,
                        });
                    }
                }
            },
            template: `
                <div class="row">
                    <div class="col sm-6">
												<form>
														<field-editor-component
														     name-editor-component="field-input-component"
														     name-viewer-component="teleport-to-header-component"
														     v-model="title"
														     name="title"
														     :is-edit="isNew"
														     @save="save_project"
														     verbose-name="{{ fields.title.verbose_name }}"
														     :show-cancel-btn="!isNew"
														>{{ fields.title.verbose_name }}</field-editor-component>
														<br>
														<field-editor-component
														    name-editor-component="field-textarea-component"
														    name-viewer-component="div"
														    v-model="short_description"
														    name="short_description"
														    :disabled="isNew"
														    :is-edit="isNew"
														    @save="save_project"
														    verbose-name="{{ fields.short_description.verbose_name }}"
														    :title="isNew ? 'Пожалуйста заполните и сохраните название проекта' : ''"
														    :show-cancel-btn="!isNew"
														>{{ fields.short_description.verbose_name }}</field-editor-component>
														<br>
														<field-editor-component
														    name-editor-component="field-textarea-component"
														    name-viewer-component="div"
														    v-model="description"
														    name="description"
														    :disabled="isNew"
														    :is-edit="isNew"
														    @save="save_project"
														    verbose-name="{{ fields.description.verbose_name }}"
														    :title="isNew ? 'Пожалуйста заполните и сохраните название проекта' : ''"
														    :show-cancel-btn="!isNew"
														>{{ fields.description.verbose_name }}</field-editor-component>
												</form>

												<br>

                        <p>
    												<li>Автор проекта: [[created_by]]</li>
    										</p>

                        <h4>Новости проекта</h4>

    										<news-block-component
    										:project_news="news"
    										></news-block-component>

                    </div>

                    <div class="col sm-6">
												<!--
												<h4>Цели проекта</h4>
												<h4>Связь с участниками</h4>
												-->

                        <linker-component
                            item="LinkerItemFaciComponent"
                            title="Холсты фасилитации"
                            :objects="facis.objects"
                            :num-pages="facis.num_pages"
                            :page="facis.page"
                            create-object-text="Новая встреча"
                            :create-object-url="facis.url_new"
                            :show-create-btn="!isNew"
                            :error="facis.error"
                        ></linker-component>

                        <linker-component
                            item="LinkerItemNoteComponent"
                            title="База знаний"
                            :objects="notes.objects"
                            :num-pages="notes.num_pages"
                            :page="notes.page"
                            create-object-text="Новая заметка"
                            :create-object-url="notes.url_new"
                            :show-create-btn="!isNew"
                            :error="notes.error"
                        ></linker-component>

									  </div>
                </div>
            `,
        }
    </script>

    <script>
        var project_object = JSON.parse(document.getElementById('project_json').textContent);
        const { createApp } = Vue;

        var app_project = createApp(ProjectComponent);
        app_project.config.compilerOptions.delimiters = [ '[[', ']]' ];
        app_project.mount('#app_project_id');
    </script>
{% endblock %}
